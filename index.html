<!DOCTYPE html>
<html lang="en-AU">
<head>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4852698472752437"
 crossorigin="anonymous"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fuel Cost Calculator - Australia</title>
  <meta name="description" content="Calculate fuel costs and travel expenses for long-distance driving in Australia and Asia-Pacific. Includes toll estimation and fuel consumption calculator." />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --bg:#f6f8fa; --card:#ffffff; --muted:#4b5563; --text:#0b1220;
      --accent:#0ea5a3; --accent-2:#4f46e5; --button-h:48px;
      --max-width:970px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;width:100%;overflow-x:hidden}
    body{margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background:linear-gradient(180deg,var(--bg) 0%, #e9eef5 100%);color:var(--text);
      padding:16px;display:flex;align-items:flex-start;justify-content:center;min-height:100vh;}
    .wrap{width:100%;max-width:var(--max-width);margin:0 auto;padding:0 8px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:1.25rem}
    h2{font-size:1.1rem;margin:16px 0 12px 0}
    .tabs button{background:transparent;border:1px solid transparent;color:var(--muted);
      padding:.6rem 1rem;border-radius:.6rem;margin-left:.5rem;cursor:pointer;font-weight:700;
      font-size:.95rem;height:var(--button-h);}
    .tabs button[aria-selected="true"]{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white}
    main.container{display:grid;grid-template-columns:1fr;gap:16px;width:100%}
    .card{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 8px 24px rgba(15,23,42,0.06);border:1px solid rgba(15,23,42,0.04);width:100%;overflow:hidden}
    .layout{display:grid;grid-template-columns:minmax(0,420px) minmax(0,1fr);gap:16px;align-items:start;width:100%}
    label{display:block;margin:.5rem 0 .25rem 0;font-size:.9rem;color:var(--muted);font-weight:500}
    input[type="number"], input[type="text"], select{width:100%;padding:.6rem .75rem;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:transparent;color:var(--text);outline:none;font-size:1rem;margin-top:.25rem}
    .km-row{display:flex;gap:8px;align-items:center;flex-wrap:nowrap}.km-row .km-input{flex:1;min-width:0}
    .spinner{display:flex;flex-direction:column;gap:6px}.spinner button{width:44px;height:44px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-weight:800;font-size:18px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .big-action{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}.btn{flex:1;height:var(--button-h);border-radius:10px;border:none;cursor:pointer;font-weight:700;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;font-size:1rem;min-width:140px}.btn.secondary{background:#eef2ff;color:var(--accent-2);border:1px solid rgba(79,70,229,0.08)}.btn.large{font-size:1.05rem;padding:0 14px;height:54px}
    .resultbox{margin-top:12px;padding:12px;border-radius:8px;background:linear-gradient(180deg,#ffffff,#fbfdff);border:1px solid rgba(15,23,42,0.03)}
    .result-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed rgba(15,23,42,0.03);gap:8px}
    .result-row:last-child{border-bottom:0}.result-key{color:var(--muted);font-size:.95rem}.result-val{font-weight:800;color:var(--accent-2)}
    #map{width:100%;height:360px;min-height:280px;border-radius:8px;border:1px solid rgba(15,23,42,0.06)}.small{font-size:.9rem;color:var(--muted)}
    .hint{font-size:.85rem;color:var(--accent);margin-top:4px;min-height:18px;display:block}
    .hint.error{color:#e53e3e}
    .price-table{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}.price-card{flex:1;min-width:140px;padding:8px;border-radius:8px;background:#fafafa;border:1px solid rgba(15,23,42,0.03);text-align:center}.price-card strong{display:block;font-size:1.05rem;color:var(--accent-2);margin-top:6px}
    .intro-section{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 8px 24px rgba(15,23,42,0.06);border:1px solid rgba(15,23,42,0.04);margin-bottom:16px;line-height:1.6}
    .intro-section p{margin:0 0 12px 0;color:var(--text)}
    .intro-section ul{margin:8px 0;padding-left:20px}
    .intro-section li{margin:6px 0;color:var(--text)}
    .faq-section{background:var(--card);border-radius:10px;padding:16px;box-shadow:0 8px 24px rgba(15,23,42,0.06);border:1px solid rgba(15,23,42,0.04);margin-top:16px;margin-bottom:16px}
    .faq-section h2{margin-top:0}
    .faq-item{margin:12px 0}
    .faq-item summary{cursor:pointer;font-weight:600;color:var(--accent-2);padding:8px;border-radius:6px;background:rgba(79,70,229,0.05)}
    .faq-item summary:hover{background:rgba(79,70,229,0.1)}
    .faq-item p{margin:12px 0 0 0;color:var(--text);line-height:1.6}
    .price-input-group{display:flex;gap:8px;align-items:flex-start;margin-top:8px}
    .price-input-group > div:first-child{flex:1}
    .price-input-group .btn.secondary{width:160px;flex-shrink:0}
    @media(max-width:980px){
      body{padding:12px}
      .layout{grid-template-columns:1fr}
      #map{height:260px}
      .spinner button{width:38px;height:38px}
    }
    @media(max-width:720px){
      h1{font-size:1.1rem}
      .tabs button{margin-left:0.25rem;padding:.55rem .85rem}
      .big-action{flex-direction:column}
      .btn{width:100%}
      .km-row{flex-wrap:wrap}
      .spinner{flex-direction:row}
      #map{height:240px}
      .price-input-group{flex-wrap:wrap}
      .price-input-group .btn.secondary{width:100%}
      label{margin:.6rem 0 .3rem 0}
      input[type="number"], input[type="text"], select{margin-top:.3rem}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Fuel Cost Calculator</h1>
      <nav class="tabs" role="tablist">
        <button role="tab" data-target="fuel" aria-selected="true">Fuel Costs</button>
        <button role="tab" data-target="calc">Calculator</button>
      </nav>
    </header>

    <section class="intro-section" aria-label="Introduction to fuel cost calculator">
      <h2>Calculate your fuel costs and travel expenses instantly</h2>
      <p>Our fuel cost calculator helps you determine the exact costs for your road trip. Enter the distance, your vehicle's fuel consumption, and the current fuel price — and instantly get a detailed cost breakdown including tolls, wear & tear, and other running costs.</p>
      <p><strong>Features:</strong></p>
      <ul>
        <li>Enter distance manually or calculate automatically (start/destination)</li>
        <li>Automatic country detection with default fuel prices</li>
        <li>Toll estimation for 40+ countries</li>
        <li>Cost splitting by number of passengers</li>
        <li>Interactive map with route markers</li>
      </ul>
    </section>

    <main class="container">
      <section id="fuel" class="card active" aria-hidden="false">
        <div class="layout">
          <div>
            <h2 style="margin:0 0 8px 0;font-size:1rem">Inputs</h2>

            <label for="km">Distance (km) — or calculate from / to</label>
            <div class="km-row">
              <input id="km" class="km-input" type="number" inputmode="decimal" min="0" step="0.1" placeholder="e.g. 120.5" aria-label="Distance in kilometres" />
              <div class="spinner" title="Increase / decrease distance">
                <button id="km-inc" aria-label="Increase distance">▲</button>
                <button id="km-dec" aria-label="Decrease distance">▼</button>
              </div>
            </div>

            <div style="margin-top:12px">
              <label for="place-from">Or: Start (City, Country)</label>
              <input id="place-from" type="text" placeholder="e.g. Sydney, Australia" aria-label="Starting location" />
              <label for="place-to" style="margin-top:10px">Destination (City, Country)</label>
              <input id="place-to" type="text" placeholder="e.g. Melbourne, Australia" aria-label="Destination location" />
              <div class="map-controls" style="margin-top:10px">
                <button id="btn-geocode" class="btn secondary">Calculate Distance</button>
                <button id="btn-clearmap" class="btn secondary">Reset Map</button>
              </div>
              <div class="small">Distance calculated via Nominatim (OpenStreetMap). Map tiles: OpenStreetMap.</div>
            </div>

            <label for="fuel-type" style="margin-top:12px">Fuel Type</label>
            <select id="fuel-type" aria-label="Fuel Type">
              <option value="unleaded91">Unleaded 91</option>
              <option value="unleaded95">Unleaded 95</option>
              <option value="diesel">Diesel</option>
            </select>

            <label for="consumption" style="margin-top:12px">Consumption (L/100 km)</label>
            <input id="consumption" type="number" inputmode="decimal" min="0" step="0.1" value="7.5" placeholder="e.g. 7.5" aria-label="Vehicle fuel consumption in litres per 100 km" />

            <div class="price-input-group">
              <div>
                <label for="price">Price per Litre ($)</label>
                <input id="price" type="number" inputmode="decimal" min="0" step="0.01" placeholder="e.g. 1.95" aria-label="Fuel price per litre in dollars" />
                <span id="price-info" class="hint"></span>
              </div>
              <button id="btn-reset-price" class="btn secondary" style="height:auto;padding:10px 12px;margin-top:28px" title="Reset to default price">Reset Price</button>
            </div>

            <div class="price-table" aria-hidden="false">
              <div class="price-card">
                <div class="small">Avg Unleaded 91</div>
                <strong id="avg-unleaded91">— $</strong>
              </div>
              <div class="price-card">
                <div class="small">Avg Unleaded 95</div>
                <strong id="avg-unleaded95">— $</strong>
              </div>
              <div class="price-card">
                <div class="small">Avg Diesel</div>
                <strong id="avg-diesel">— $</strong>
              </div>
            </div>

            <label for="passengers" style="margin-top:12px">Passengers (incl. driver)</label>
            <input id="passengers" type="number" min="1" step="1" value="1" aria-label="Number of passengers including driver" />

            <div class="big-action">
              <button id="calc-fuel" class="btn large">Calculate</button>
              <button id="reset-fuel" class="btn secondary large">Reset</button>
            </div>

            <div class="resultbox" aria-live="polite" aria-label="Calculation results">
              <div class="result-row"><div class="result-key">Fuel Costs</div><div class="result-val" id="cost-fuel">$0.00</div></div>
              <div class="result-row"><div class="result-key">Running Costs incl. Tolls (estimated)</div><div class="result-val" id="cost-running">$0.00</div></div>
              <div class="result-row"><div class="result-key">Total Costs</div><div class="result-val" id="cost-total">$0.00</div></div>
              <div class="result-row"><div class="result-key">Per Person</div><div class="result-val" id="cost-person">$0.00</div></div>
              <div class="result-row"><div class="result-key">Litres Required</div><div class="result-val" id="liters">0.00 L</div></div>
              <div class="result-row"><div class="result-key">Average ($/100 km)</div><div class="result-val" id="avg100">$0.00 /100km</div></div>
              <div class="result-row"><div class="result-key small">Estimated running costs /100 km (incl. tolls)</div><div class="result-val small" id="running-est">— $ /100km</div></div>
              <div style="margin-top:8px;color:var(--muted);font-size:.85rem">
                Running costs include: wear & tear, maintenance, insurance, tyres, depreciation, taxes and region-specific toll estimates.
              </div>
            </div>
          </div>

          <div>
            <h2 style="margin:0 0 8px 0;font-size:1rem">Map & Distance</h2>
            <div id="map"></div>
            <div style="margin-top:8px" class="small">Click "Calculate Distance" to search for start/destination. Tolls are automatically estimated by region.</div>
            <div id="toll-info" class="small" style="margin-top:6px;color:var(--muted)"></div>
          </div>
        </div>
      </section>

      <section id="calc" class="card" aria-hidden="true" style="display:none">
        <h2>Calculator</h2>
        <label for="num1">Number 1</label>
        <input id="num1" type="number" inputmode="decimal" placeholder="Number 1" aria-label="First number" />
        <label for="num2">Number 2</label>
        <input id="num2" type="number" inputmode="decimal" placeholder="Number 2" aria-label="Second number" />
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;max-width:240px">
          <button data-op="+" class="btn" style="height:44px;font-size:1.1rem" aria-label="Add">+</button>
          <button data-op="-" class="btn" style="height:44px;font-size:1.1rem" aria-label="Subtract">−</button>
          <button data-op="*" class="btn" style="height:44px;font-size:1.1rem" aria-label="Multiply">×</button>
          <button data-op="/" class="btn" style="height:44px;font-size:1.1rem" aria-label="Divide">÷</button>
        </div>

        <p style="margin-top:12px" class="small">Result: <strong id="result">–</strong></p>
      </section>
    </main>

    <section class="faq-section" aria-label="Frequently asked questions">
      <h2>Frequently Asked Questions (FAQ)</h2>
      
      <details class="faq-item">
        <summary>How is fuel consumption measured?</summary>
        <p>Fuel consumption is measured in litres per 100 kilometres (L/100 km). If your car uses 7.5 litres per 100 km, enter 7.5. You'll find this in your vehicle's manual or can estimate it (small cars: 5–7 L/100 km, larger vehicles: 8–12 L/100 km).</p>
      </details>

      <details class="faq-item">
        <summary>Where can I find current fuel prices?</summary>
        <p>The calculator uses average prices for your detected country. For current prices, check fuel price apps or websites like NRMA FuelCheck (Australia) or equivalent services in your region. These often show the cheapest stations nearby.</p>
      </details>

      <details class="faq-item">
        <summary>What are "running costs"?</summary>
        <p>Running costs include fuel price plus wear & tear, maintenance, insurance, tyres, and taxes. The calculator estimates these based on your consumption: approximately 0.9 × consumption + 2.0 $/100 km. Plus region-specific tolls (motorway fees, vignettes).</p>
      </details>

      <details class="faq-item">
        <summary>How is distance calculated automatically?</summary>
        <p>Enter your start and destination (e.g., "Sydney, Australia" and "Melbourne, Australia"), then click "Calculate Distance". The calculator uses the Nominatim service (OpenStreetMap) to find the locations and calculate the distance. Road distance may be slightly longer than the straight-line distance shown.</p>
      </details>

      <details class="faq-item">
        <summary>Are the toll costs accurate?</summary>
        <p>Toll costs are estimated based on average motorway fees and vignettes for each country. They're not exact, as actual tolls depend on route, vehicle class, and number of axles. Use the calculator as a rough guide, not for official invoicing.</p>
      </details>

      <details class="faq-item">
        <summary>Can I enter prices manually?</summary>
        <p>Yes! Default prices are just suggestions. You can always override them with your own price. If your country isn't recognised or you want to use different prices, simply type in your custom price. Click "Reset Price" to return to the default.</p>
      </details>

      <details class="faq-item">
        <summary>What's the difference between Unleaded 91, 95, and Diesel?</summary>
        <p><strong>Unleaded 91:</strong> Standard petrol for most older vehicles. <strong>Unleaded 95:</strong> Higher octane, for modern cars, slightly more efficient. <strong>Diesel:</strong> For diesel vehicles, uses less fuel but costs more per litre. Check your vehicle's manual for the correct type.</p>
      </details>

      <details class="faq-item">
        <summary>Can I use this calculator in other countries?</summary>
        <p>Yes! The calculator works worldwide and supports 40+ countries with automatic price detection. It recognises locations like "Berlin, Germany" or "Tokyo, Japan" and sets default prices accordingly. You can always override prices manually for any country.</p>
      </details>
    </section>

    <footer style="margin-top:12px" class="small">
      Internet required for maps/geocoding. Prices can optionally be loaded via your own HTTPS endpoint.
      <span style="font-size:0.75rem;color:var(--muted);opacity:0.65;margin-left:10px">|
        <a href="legal.html" style="color:inherit;text-decoration:none;margin:0 6px">Legal Notice</a>
        <a href="privacy.html" style="color:inherit;text-decoration:none;margin:0 6px">Privacy Policy</a>
        <a href="terms.html" style="color:inherit;text-decoration:none;margin:0 6px">Terms</a>
        <a href="contact.html" style="color:inherit;text-decoration:none;margin:0 6px">Contact</a>
      </span>
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const MAPBOX_API_KEY = ''; // Optional: Mapbox API key for enhanced geocoding

      // Tabs
      document.querySelectorAll('.tabs [role="tab"]').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tabs [role="tab"]').forEach(b => b.setAttribute('aria-selected','false'));
          btn.setAttribute('aria-selected','true');
          const target = btn.dataset.target;
          document.querySelectorAll('main > section').forEach(s => {
            s.style.display = (s.id === target) ? '' : 'none';
            s.setAttribute('aria-hidden', s.id === target ? 'false' : 'true');
          });
        });
      });

      const parse = v => (v === '' || v == null) ? NaN : Number(String(v).replace(',', '.'));
      const fmt = n => (Number.isFinite(n) ? Number.parseFloat(n.toFixed(2)).toFixed(2) : '0.00');

      // DOM
      const kmEl = document.getElementById('km');
      const consumptionEl = document.getElementById('consumption');
      const priceEl = document.getElementById('price');
      const passengersEl = document.getElementById('passengers');
      const fuelTypeEl = document.getElementById('fuel-type');

      const litersEl = document.getElementById('liters');
      const costFuelEl = document.getElementById('cost-fuel');
      const costRunningEl = document.getElementById('cost-running');
      const costTotalEl = document.getElementById('cost-total');
      const costPersonEl = document.getElementById('cost-person');
      const avg100El = document.getElementById('avg100');
      const runningEstEl = document.getElementById('running-est');

      const avgUnleaded91El = document.getElementById('avg-unleaded91');
      const avgUnleaded95El = document.getElementById('avg-unleaded95');
      const avgDieselEl = document.getElementById('avg-diesel');
      const tollInfoEl = document.getElementById('toll-info');
      const priceInfoEl = document.getElementById('price-info');
      const placeFromEl = document.getElementById('place-from');

      // Country-based default fuel prices (AUD per litre)
      const countryFuelPrices = {
        au: { unleaded91:1.85, unleaded95:1.95, diesel:1.90, name:'Australia' },
        nz: { unleaded91:2.10, unleaded95:2.20, diesel:2.05, name:'New Zealand' },
        id: { unleaded91:0.85, unleaded95:0.95, diesel:0.80, name:'Indonesia' },
        my: { unleaded91:0.75, unleaded95:0.85, diesel:0.70, name:'Malaysia' },
        sg: { unleaded91:2.50, unleaded95:2.60, diesel:2.40, name:'Singapore' },
        th: { unleaded91:1.40, unleaded95:1.50, diesel:1.35, name:'Thailand' },
        ph: { unleaded91:1.55, unleaded95:1.65, diesel:1.50, name:'Philippines' },
        vn: { unleaded91:1.30, unleaded95:1.40, diesel:1.25, name:'Vietnam' },
        jp: { unleaded91:2.20, unleaded95:2.30, diesel:2.10, name:'Japan' },
        kr: { unleaded91:2.15, unleaded95:2.25, diesel:2.00, name:'South Korea' },
        cn: { unleaded91:1.60, unleaded95:1.70, diesel:1.55, name:'China' },
        in: { unleaded91:1.45, unleaded95:1.55, diesel:1.40, name:'India' },
        ae: { unleaded91:0.95, unleaded95:1.05, diesel:0.90, name:'UAE' },
        us: { unleaded91:1.40, unleaded95:1.50, diesel:1.45, name:'USA' },
        uk: { unleaded91:2.60, unleaded95:2.70, diesel:2.55, name:'UK' },
        gb: { unleaded91:2.60, unleaded95:2.70, diesel:2.55, name:'UK' },
        de: { unleaded91:2.65, unleaded95:2.75, diesel:2.50, name:'Germany' },
        fr: { unleaded91:2.70, unleaded95:2.80, diesel:2.55, name:'France' },
      };

      // Country name mappings
      const countryNameMap = {
        'australia': 'au', 'au': 'au',
        'new zealand': 'nz', 'nz': 'nz',
        'indonesia': 'id', 'id': 'id',
        'malaysia': 'my', 'my': 'my',
        'singapore': 'sg', 'sg': 'sg',
        'thailand': 'th', 'th': 'th',
        'philippines': 'ph', 'ph': 'ph',
        'vietnam': 'vn', 'vn': 'vn',
        'japan': 'jp', 'jp': 'jp',
        'south korea': 'kr', 'korea': 'kr', 'kr': 'kr',
        'china': 'cn', 'cn': 'cn',
        'india': 'in', 'in': 'in',
        'uae': 'ae', 'dubai': 'ae', 'ae': 'ae',
        'united states': 'us', 'usa': 'us', 'us': 'us', 'america': 'us',
        'united kingdom': 'uk', 'uk': 'uk', 'gb': 'uk', 'england': 'uk', 'britain': 'uk',
        'germany': 'de', 'deutschland': 'de', 'de': 'de',
        'france': 'fr', 'frankreich': 'fr', 'fr': 'fr',
      };

      // Fallback prices (Australian defaults)
      let fuelPrices = { unleaded91:1.85, unleaded95:1.95, diesel:1.90 };
      let userEditedPrice = false;
      function renderAvgPrices(){
        avgUnleaded91El.textContent = '$' + fmt(fuelPrices.unleaded91);
        avgUnleaded95El.textContent = '$' + fmt(fuelPrices.unleaded95);
        avgDieselEl.textContent = '$' + fmt(fuelPrices.diesel);
      }
      renderAvgPrices();

      fuelTypeEl.addEventListener('change', () => {
        if(!userEditedPrice) {
          const t = fuelTypeEl.value;
          priceEl.value = fuelPrices[t] || '';
        }
      });

      // Track manual price edits
      priceEl.addEventListener('input', () => {
        userEditedPrice = true;
        priceInfoEl.textContent = '';
        priceInfoEl.classList.remove('error');
      });

      // Parse country from location string
      function parseCountryFromLocation(locationStr) {
        if(!locationStr || !locationStr.trim()) return null;
        const parts = locationStr.split(',').map(p => p.trim().toLowerCase());
        if(parts.length === 0) return null;
        
        for(let i = parts.length - 1; i >= 0; i--) {
          const part = parts[i];
          if(countryNameMap[part]) {
            return countryNameMap[part];
          }
        }
        return null;
      }

      // Update fuel prices based on detected country
      function updatePricesFromCountry(countryCode) {
        if(!countryCode || !countryFuelPrices[countryCode]) return false;
        
        const prices = countryFuelPrices[countryCode];
        fuelPrices = { unleaded91: prices.unleaded91, unleaded95: prices.unleaded95, diesel: prices.diesel };
        renderAvgPrices();
        
        if(!userEditedPrice) {
          const currentFuel = fuelTypeEl.value;
          priceEl.value = fuelPrices[currentFuel] || '';
          priceInfoEl.textContent = `Default price for ${prices.name} set – you can change it.`;
          priceInfoEl.classList.remove('error');
        }
        return true;
      }

      // Listen to location input changes
      let locationDebounceTimer = null;
      
      function detectAndApplyCountryPrice() {
        const location = placeFromEl.value.trim();
        if(!location) return;
        
        const countryCode = parseCountryFromLocation(location);
        if(countryCode) {
          updatePricesFromCountry(countryCode);
        } else {
          priceInfoEl.textContent = 'Country not recognised – please enter price manually.';
          priceInfoEl.classList.add('error');
        }
      }
      
      placeFromEl.addEventListener('blur', detectAndApplyCountryPrice);
      placeFromEl.addEventListener('input', () => {
        clearTimeout(locationDebounceTimer);
        locationDebounceTimer = setTimeout(detectAndApplyCountryPrice, 400);
      });

      // Reset price to default
      document.getElementById('btn-reset-price').addEventListener('click', () => {
        userEditedPrice = false;
        const location = placeFromEl.value.trim();
        if(location) {
          const countryCode = parseCountryFromLocation(location);
          if(countryCode && updatePricesFromCountry(countryCode)) {
            return;
          }
        }
        priceEl.value = fuelPrices[fuelTypeEl.value] || '';
        priceInfoEl.textContent = 'Default price restored.';
        priceInfoEl.classList.remove('error');
      });

      // Map (centered on Australia)
      const map = L.map('map', { attributionControl: true }).setView([-25.2744, 133.7751], 4);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
      let markers = [];
      function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers = []; }
      function addMarker(lat, lon, label){ const m = L.marker([lat, lon]).addTo(map).bindPopup(label||''); markers.push(m); return m; }

      function haversineKm(lat1, lon1, lat2, lon2){
        const R = 6371; const toRad = d => d * Math.PI / 180;
        const dLat = toRad(lat2 - lat1); const dLon = toRad(lon2 - lon1);
        const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
      }

      async function geocode(q){
        if(MAPBOX_API_KEY){
          try{
            const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?access_token=${encodeURIComponent(MAPBOX_API_KEY)}&limit=1&language=en`;
            const res = await fetch(url);
            if(res.ok){
              const data = await res.json();
              if(data && Array.isArray(data.features) && data.features.length){
                const f = data.features[0];
                return { lat: f.center[1], lon: f.center[0], name: f.place_name };
              }
            }
          }catch(err){
            console.warn('Mapbox geocoding failed, falling back to Nominatim', err);
          }
        }
        const url = 'https://nominatim.openstreetmap.org/search?format=json&limit=1&q=' + encodeURIComponent(q);
        const res = await fetch(url, { headers:{ 'Accept-Language':'en' }});
        if(!res.ok) throw new Error('Geocoding failed');
        const data = await res.json();
        if(data && data.length) return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), name: data[0].display_name };
        return null;
      }

      // Region-specific tolls per 100 km (AUD estimates)
      const tollPer100km = {
        au:5, nz:3, jp:12, kr:10, sg:15, my:2, id:1, th:3, ph:2, vn:1, cn:4, in:2,
        de:0, fr:12, it:10, es:15, us:3, uk:0, ae:5
      };

      async function estimateTollsMultiCountry(pointA, pointB){
        const dist = haversineKm(pointA.lat, pointA.lon, pointB.lat, pointB.lon);
        const samplesCount = Math.min(15, Math.max(5, Math.ceil(dist / 150)));
        const samples = [];
        for(let i=0;i<=samplesCount;i++){
          const t = i / samplesCount;
          samples.push({ lat: pointA.lat + (pointB.lat - pointA.lat) * t, lon: pointA.lon + (pointB.lon - pointA.lon) * t });
        }

        const countriesFound = new Set();
        for(const s of samples){
          try{
            const rev = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${s.lat}&lon=${s.lon}`);
            if(rev.ok){
              const j = await rev.json();
              const cc = j.address && j.address.country_code ? j.address.country_code.toLowerCase() : null;
              if(cc) countriesFound.add(cc);
            }
          }catch(e){ /* ignore */ }
          await new Promise(r => setTimeout(r, 250));
        }

        const countries = Array.from(countriesFound);
        const segmentKm = dist / Math.max(1, countries.length);
        let totalToll = 0;
        const breakdown = [];
        for(const cc of countries){
          const rate = tollPer100km[cc] != null ? tollPer100km[cc] : 5;
          const cost = (segmentKm / 100) * rate;
          totalToll += cost;
          breakdown.push({ country: cc.toUpperCase(), ratePer100: rate, segmentKm, cost: Math.round(cost * 100) / 100 });
        }

        return {
          totalCost: Math.round(totalToll * 100) / 100,
          countries: breakdown,
          distKm: dist
        };
      }

      let estimatedTollPer100 = 0;

      document.getElementById('btn-geocode').addEventListener('click', async () => {
        const from = placeFromEl.value.trim();
        const to = document.getElementById('place-to').value.trim();
        if(!from || !to){ 
          tollInfoEl.textContent = 'Please enter start and destination.';
          tollInfoEl.classList.add('error');
          return;
        }
        try{
          const a = await geocode(from);
          const b = await geocode(to);
          if(!a || !b){ 
            tollInfoEl.textContent = 'Location not found. Please be more specific.';
            tollInfoEl.classList.add('error');
            return;
          }
          
          const countryCode = parseCountryFromLocation(from);
          if(countryCode) {
            updatePricesFromCountry(countryCode);
          }
          clearMarkers();
          addMarker(a.lat,a.lon,'Start: '+a.name);
          addMarker(b.lat,b.lon,'Destination: '+b.name);
          map.fitBounds([[a.lat,a.lon],[b.lat,b.lon]], { padding:[60,60] });
          const dist = haversineKm(a.lat,a.lon,b.lat,b.lon);
          kmEl.value = Math.round(dist*10)/10;

          tollInfoEl.textContent = 'Estimating tolls (multiple region samples) …';
          tollInfoEl.classList.remove('error');
          const toll = await estimateTollsMultiCountry(a,b);
          if(toll && toll.distKm > 0){
            estimatedTollPer100 = +(toll.totalCost / toll.distKm * 100).toFixed(2);
            const breakdown = toll.countries.map(c => `${c.country}: $${fmt(c.cost)}`).join(', ');
            tollInfoEl.textContent = `Tolls (estimated): $${fmt(toll.totalCost)} total — Regions: ${breakdown} — approx. $${fmt(estimatedTollPer100)} /100 km`;
          } else {
            estimatedTollPer100 = 0;
            tollInfoEl.textContent = `No toll estimate available.`;
          }
        }catch(e){
          console.error(e);
          tollInfoEl.textContent = 'Error during geocoding or toll estimation. Check connection.';
          tollInfoEl.classList.add('error');
        }
      });

      document.getElementById('btn-clearmap').addEventListener('click', () => {
        clearMarkers(); map.setView([-25.2744, 133.7751],4);
        placeFromEl.value=''; document.getElementById('place-to').value='';
        tollInfoEl.textContent = ''; 
        tollInfoEl.classList.remove('error');
        estimatedTollPer100 = 0;
      });

      document.getElementById('km-inc').addEventListener('click', ()=>{ const cur = parse(kmEl.value)||0; kmEl.value = Math.round((cur+1)*10)/10; });
      document.getElementById('km-dec').addEventListener('click', ()=>{ const cur = parse(kmEl.value)||0; kmEl.value = Math.max(0, Math.round((cur-1)*10)/10); });

      function estimateRunningPer100(consumptionL100){
        if(!Number.isFinite(consumptionL100) || consumptionL100 <= 0) return 12.0;
        const est = 1.2 * consumptionL100 + 3.5;
        return Math.max(5, Math.min(30, Math.round(est * 10) / 10));
      }

      document.getElementById('calc-fuel').addEventListener('click', () => {
        const km = parse(kmEl.value);
        const v = parse(consumptionEl.value);
        let p = parse(priceEl.value);
        const passengers = Math.max(1, Math.floor(parse(passengersEl.value) || 1));

        if(!Number.isFinite(p)){
          p = (fuelTypeEl && fuelTypeEl.value && ({ unleaded91:1.85,unleaded95:1.95,diesel:1.90 })[fuelTypeEl.value]) || NaN;
        }

        if(Number.isNaN(km) || km <= 0 || Number.isNaN(v) || Number.isNaN(p)){
          priceInfoEl.textContent = 'Please enter distance, consumption and price correctly.';
          priceInfoEl.classList.add('error');
          return;
        }
        priceInfoEl.textContent = '';
        priceInfoEl.classList.remove('error');

        const liters = (km * v) / 100;
        const costFuel = liters * p;

        const runningPer100Base = estimateRunningPer100(v);
        const runningPer100Total = runningPer100Base + (estimatedTollPer100 || 0);

        const costRunning = (km * runningPer100Total) / 100;
        const total = costFuel + costRunning;
        const perPerson = total / passengers;
        const avgPer100 = (total / km) * 100;

        litersEl.textContent = fmt(liters) + ' L';
        costFuelEl.textContent = '$' + fmt(costFuel);
        costRunningEl.textContent = '$' + fmt(costRunning);
        costTotalEl.textContent = '$' + fmt(total);
        costPersonEl.textContent = '$' + fmt(perPerson);
        avg100El.textContent = '$' + fmt(avgPer100) + ' /100km';
        runningEstEl.textContent = '$' + fmt(runningPer100Total) + ' /100km';
      });

      document.getElementById('reset-fuel').addEventListener('click', () => {
        kmEl.value = ''; consumptionEl.value = '7.5'; priceEl.value = ''; passengersEl.value = 1;
        litersEl.textContent='0.00 L'; costFuelEl.textContent='$0.00'; costRunningEl.textContent='$0.00';
        costTotalEl.textContent='$0.00'; costPersonEl.textContent='$0.00'; avg100El.textContent='$0.00 /100km';
        runningEstEl.textContent='— $ /100km'; tollInfoEl.textContent=''; 
        tollInfoEl.classList.remove('error');
        estimatedTollPer100 = 0;
        priceInfoEl.textContent = ''; 
        priceInfoEl.classList.remove('error');
        userEditedPrice = false;
        clearMarkers(); map.setView([-25.2744, 133.7751],4);
      });

      // Calculator
      const num1 = document.getElementById('num1');
      const num2 = document.getElementById('num2');
      const result = document.getElementById('result');
      document.querySelectorAll('[data-op]').forEach(btn =>
        btn.addEventListener('click', () => {
          const a = parse(num1.value); const b = parse(num2.value);
          if(Number.isNaN(a) || Number.isNaN(b)){ result.textContent = '–'; return; }
          let res;
          switch(btn.dataset.op){
            case '+': res = a + b; break;
            case '-': res = a - b; break;
            case '*': res = a * b; break;
            case '/': res = (b === 0 ? '∞' : a / b); break;
          }
          result.textContent = (typeof res === 'number') ? fmt(res) : res;
        })
      );
    });
  </script>
</body>
</html>
