<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <title>Fuel Cost Calculator ‚Äì Calculate Trip Costs, Split Per Person & Compare CO‚ÇÇ | PetrolCostCalculator.com</title>
  <meta name="description" content="Free fuel cost calculator. Calculate fuel costs, total trip costs, per-person split, and (Europe-only) toll/vignette estimates with map-based routing." />
  <meta name="robots" content="index, follow" />

  <link rel="canonical" href="https://petrolcostcalculator.com/" />
  <link rel="alternate" hreflang="en" href="https://petrolcostcalculator.com/" />
  <link rel="alternate" hreflang="de" href="https://spritkosten-check.de/" />
  <link rel="alternate" hreflang="x-default" href="https://petrolcostcalculator.com/" />

  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <link rel="icon" href="/favicon.ico">

  <link rel="stylesheet" href="/assets/css/style.css?v=2026-02" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "Fuel Cost Calculator",
    "description": "Free online calculator for fuel costs, trip costs, and a Europe-only toll/vignette estimate with map routing.",
    "url": "https://petrolcostcalculator.com/",
    "applicationCategory": "UtilityApplication",
    "operatingSystem": "Web",
    "offers": {"@type":"Offer","price":"0","priceCurrency":"AUD"}
  }
  </script>
</head>

<body data-page="home">

  <div id="site-header"></div>

  <main class="page-container" aria-label="Page content">

    <div class="ad-block" aria-label="Advertising">
      <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-4852698472752437"
        data-ad-slot="7158625008"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>

    <section class="card intro-section" aria-label="Fuel cost calculator introduction">
      <h2>Free Fuel Cost Calculator ‚Äì Plan Your Trip Costs</h2>
      <p>
        This <strong>fuel cost calculator</strong> helps you estimate the total cost of your trip.
        <strong>Free ‚Äì no registration required.</strong>
        Enter distance, consumption and fuel price to get a breakdown of fuel cost, running costs and an optional (Europe-only) toll/vignette estimate.
      </p>
      <ul>
        <li><strong>Worldwide:</strong> places via OpenStreetMap</li>
        <li><strong>Distance:</strong> real road route + map</li>
        <li><strong>Tolls/Vignettes:</strong> Europe-only estimate (guideline)</li>
        <li><strong>Split costs:</strong> calculate per person</li>
      </ul>
    </section>

    <section id="fuel" class="card" aria-label="Fuel cost calculator">

      <div class="ad-block" aria-label="Advertising">
        <ins class="adsbygoogle"
          style="display:block"
          data-ad-client="ca-pub-4852698472752437"
          data-ad-slot="3355111369"
          data-ad-format="auto"
          data-full-width-responsive="true"></ins>
      </div>

      <div class="layout">

        <!-- LEFT -->
        <div>
          <h2 style="margin:0 0 8px 0;font-size:1rem">Inputs</h2>

          <label for="km">Distance (km) ‚Äî or calculate from start/destination</label>
          <div class="km-row">
            <input id="km" class="km-input" type="number" inputmode="decimal" min="0" step="0.1"
              placeholder="e.g. 120.5" aria-label="Distance in kilometres" />
            <div class="spinner" title="Increase / decrease distance">
              <button id="km-inc" aria-label="Increase distance" type="button">‚ñ≤</button>
              <button id="km-dec" aria-label="Decrease distance" type="button">‚ñº</button>
            </div>
          </div>

          <!-- ‚úÖ FIXED: unique IDs + autocomplete off -->
          <div style="margin-top:12px">
            <label for="place-from">Or: Start (place, country)</label>
            <input id="place-from" type="text"
              placeholder="e.g. Munich, Germany"
              aria-label="Start location"
              autocomplete="off"
              autocapitalize="off"
              autocorrect="off"
              spellcheck="false" />

            <label for="place-to" style="margin-top:10px">Destination (place, country)</label>
            <input id="place-to" type="text"
              placeholder="e.g. Salzburg, Austria"
              aria-label="Destination location"
              autocomplete="off"
              autocapitalize="off"
              autocorrect="off"
              spellcheck="false" />

            <div class="small" style="margin-top:4px">
              Example: <b>Munich, Germany</b> ‚Üí <b>Salzburg, Austria</b>
            </div>

            <div class="route-actions">
              <button id="btn-geocode" class="btn secondary" type="button">Calculate distance</button>
              <button id="btn-clearmap" class="btn secondary" type="button">Reset map</button>
            </div>

            <div class="country-badge" id="country-badge"></div>

            <div class="price-mode" id="price-mode">
              <div class="small" style="margin-bottom:6px;">
                Start and destination are in different countries. Which fuel price should be used?
              </div>
              <div class="row">
                <label class="pill"><input type="radio" name="priceMode" value="start"> Start</label>
                <label class="pill"><input type="radio" name="priceMode" value="avg" checked> Average</label>
                <label class="pill"><input type="radio" name="priceMode" value="dest"> Destination</label>
              </div>
            </div>
          </div>

          <label for="fuel-type" style="margin-top:12px">Fuel</label>
          <select id="fuel-type" aria-label="Fuel type">
            <option value="unleaded91">Petrol (E10 / 91)</option>
            <option value="unleaded95">Premium (95)</option>
            <option value="diesel">Diesel</option>
          </select>

          <label for="consumption" style="margin-top:12px">Consumption (L/100 km)</label>
          <input id="consumption" type="number" inputmode="decimal" min="0" step="0.1"
            value="7.5" placeholder="e.g. 7.5" aria-label="Fuel consumption" />

          <div class="price-input-group">
            <div class="price-field">
              <label for="price">Price per litre ($)</label>
              <input id="price" type="number" inputmode="decimal" min="0" step="0.01"
                placeholder="e.g. 1.89" aria-label="Fuel price per litre" />
            </div>

            <button id="btn-reset-price" class="btn secondary reset-price-btn" type="button">
              Reset to default
            </button>

            <span id="price-info" class="hint"></span>
          </div>

          <div class="price-table">
            <div class="price-card">
              <div class="small">Avg Petrol (E10/91)</div>
              <strong id="avg-unleaded91">‚Äî</strong>
            </div>
            <div class="price-card">
              <div class="small">Avg Premium (95)</div>
              <strong id="avg-unleaded95">‚Äî</strong>
            </div>
            <div class="price-card">
              <div class="small">Avg Diesel</div>
              <strong id="avg-diesel">‚Äî</strong>
            </div>
          </div>

          <label for="passengers" style="margin-top:12px">People (including driver)</label>
          <input id="passengers" type="number" min="1" step="1" value="1" aria-label="Number of people" />

          <div class="big-action">
            <button id="calc-fuel" class="btn large" type="button">Calculate</button>
            <button id="reset-fuel" class="btn secondary large" type="button">Reset</button>
          </div>

          <div class="resultbox" aria-live="polite" aria-label="Results">
            <div class="result-row"><div class="result-key">Fuel cost</div><div class="result-val" id="cost-fuel">$0.00</div></div>
            <div class="result-row"><div class="result-key">Running costs incl. toll/vignette (estimate)</div><div class="result-val" id="cost-running">$0.00</div></div>
            <div class="result-row"><div class="result-key">Total cost</div><div class="result-val" id="cost-total">$0.00</div></div>
            <div class="result-row"><div class="result-key">Per person</div><div class="result-val" id="cost-person">$0.00</div></div>
            <div class="result-row"><div class="result-key">Total litres</div><div class="result-val" id="liters">0.00 L</div></div>
            <div class="result-row"><div class="result-key">Average ($/100 km)</div><div class="result-val" id="avg100">$0.00 /100km</div></div>
            <div class="result-row"><div class="result-key small">Estimated running costs /100 km (incl. toll/vignette)</div><div class="result-val small" id="running-est">‚Äî</div></div>
            <div style="margin-top:8px;color:var(--muted);font-size:.85rem">
              Running costs include: maintenance, tyres, depreciation, insurance + toll/vignette estimate (Europe-only).
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="map-col">
          <h2 style="margin:0 0 2px 0;font-size:1rem">Map & Distance</h2>
          <div id="map"></div>
          <div id="toll-info" class="small" style="color:var(--muted)"></div>

          <!-- ‚úÖ FIXED: like DE (toll + vignette + sum + breakdown) -->
          <div class="thinbox" aria-label="Toll and vignette details" style="padding:16px 12px">
            <div class="title">Toll & Vignette ‚Äì Details</div>
            <div class="line"><div>Total tolls</div><div class="mono" id="toll-total">‚Äî</div></div>
            <div class="line"><div>Total vignettes</div><div class="mono" id="vignette-total">‚Äî</div></div>
            <div class="line"><div>Sum toll + vignette</div><div class="mono" id="toll-vignette-sum">‚Äî</div></div>
            <div style="margin-top:10px" class="small" id="toll-breakdown"></div>
          </div>

          <div class="thinbox" aria-label="CO2 footprint">
            <div class="title">üå± CO‚ÇÇ Footprint</div>
            <div class="line"><div>Total CO‚ÇÇ</div><div class="mono" id="co2-total">‚Äî</div></div>
            <div class="line"><div>CO‚ÇÇ per person</div><div class="mono" id="co2-per-person">‚Äî</div></div>
            <div class="small" style="margin-top:8px">Approximation based on your consumption (kg CO‚ÇÇ).</div>
          </div>

          <div class="thinbox" aria-label="Transport comparison">
            <div class="title">üöóüöÜ‚úàÔ∏è Comparison (guidelines)</div>
            <div class="line"><div>Car</div><div class="mono" id="cmp-car">‚Äî</div></div>
            <div class="line"><div>Train</div><div class="mono" id="cmp-rail">‚Äî</div></div>
            <div class="line"><div>Flight</div><div class="mono" id="cmp-flight">‚Äî</div></div>
            <div class="small" style="margin-top:8px">
              Values in kg CO‚ÇÇ for the route (guidelines).<br>
              Train &amp; flight: <b>per seat</b>. Car: <b>per vehicle</b>.
            </div>
          </div>
        </div>

      </div>
    </section>

    <div class="ad-block" aria-label="Advertising">
      <ins class="adsbygoogle"
        style="display:block"
        data-ad-client="ca-pub-4852698472752437"
        data-ad-slot="3048839661"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>

  </main>

  <div id="site-footer"></div>

  <div id="cookieBanner" class="is-hidden">
    <div class="row">
      <div class="txt">
        We use cookies to operate the website and display advertising.
        <a href="/privacy-policy.html">Learn more</a>.
      </div>
      <div class="actions">
        <button id="cookieReject" class="reject" type="button">Decline</button>
        <button id="cookieAccept" class="accept" type="button">Accept</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="/prices/country-prices-aud.js"></script>

  <script src="/assets/js/active-nav.js" defer></script>
  <script src="/assets/js/cookies.js" defer></script>

  <!-- ‚úÖ MAIN SCRIPT: stable + EU-only toll/vignette -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const API_BASE = "https://soft-pine-874.dominikf974.workers.dev";

    const CURRENCY_SYMBOL = '$'; // keep as-is (AUD setup)
    const parse = v => (v === '' || v == null) ? NaN : Number(String(v).replace(',', '.'));
    const fmt = n => (Number.isFinite(n) ? Number.parseFloat(n.toFixed(2)).toFixed(2) : '0.00');
    const fmtMoney = n => CURRENCY_SYMBOL + fmt(n);
    const fmtL = n => (Number.isFinite(n) ? Number.parseFloat(n.toFixed(1)).toFixed(1) : '0.0');

    function fetchWithTimeout(url, ms=12000){
      const controller = new AbortController();
      const t = setTimeout(() => controller.abort(), ms);
      return fetch(url, { signal: controller.signal }).finally(() => clearTimeout(t));
    }

    // ---------- UI refs ----------
    const kmEl = document.getElementById('km');
    const consumptionEl = document.getElementById('consumption');
    const priceEl = document.getElementById('price');
    const passengersEl = document.getElementById('passengers');
    const fuelTypeEl = document.getElementById('fuel-type');

    const litersEl = document.getElementById('liters');
    const costFuelEl = document.getElementById('cost-fuel');
    const costRunningEl = document.getElementById('cost-running');
    const costTotalEl = document.getElementById('cost-total');
    const costPersonEl = document.getElementById('cost-person');
    const avg100El = document.getElementById('avg100');
    const runningEstEl = document.getElementById('running-est');

    const avgUnleaded91El = document.getElementById('avg-unleaded91');
    const avgUnleaded95El = document.getElementById('avg-unleaded95');
    const avgDieselEl = document.getElementById('avg-diesel');

    const tollInfoEl = document.getElementById('toll-info');
    const priceInfoEl = document.getElementById('price-info');

    const placeFromEl = document.getElementById('place-from');
    const placeToEl = document.getElementById('place-to');

    const badgeEl = document.getElementById('country-badge');
    const priceModeWrap = document.getElementById('price-mode');

    const tollTotalEl = document.getElementById('toll-total');
    const vignetteTotalEl = document.getElementById('vignette-total');
    const tollVignetteSumEl = document.getElementById('toll-vignette-sum');
    const tollBreakdownEl = document.getElementById('toll-breakdown');

    const co2TotalEl = document.getElementById('co2-total');
    const co2PerPersonEl = document.getElementById('co2-per-person');
    const cmpCarEl = document.getElementById('cmp-car');
    const cmpRailEl = document.getElementById('cmp-rail');
    const cmpFlightEl = document.getElementById('cmp-flight');

    // ---------- State ----------
    let isRouting = false;
    let lastRouteClick = 0;

    const geoCache = new Map();
    const revCache = new Map();
    const routeCache = new Map();

    const cacheKeyLL = (lat,lon) => `${lat.toFixed(5)},${lon.toFixed(5)}`;
    const cacheKeyRoute = (a,b) => `${cacheKeyLL(a.lat,a.lon)}|${cacheKeyLL(b.lat,b.lon)}`;

    let startCC = null, destCC = null;
    let routeKm = 0;

    let lastTollTotal = 0;
    let lastVignetteTotal = 0;

    // Route geometry + country split cache
    let lastRouteGeo = null;    // OSRM geojson geometry
    let lastKmByCountry = null; // { DE: 120, AT: 50, ... }
    let tollRenderSeq = 0;

    // ---------- Prices ----------
    const countryPrices = window.COUNTRY_FUEL_PRICES_AUD || window.COUNTRY_FUEL_PRICES_EUR || null;
    const priceStand = window.COUNTRY_FUEL_PRICES_STAND || '';

    // fallback (AUD / litre)
    const fallbackPrices = { unleaded91: 1.85, unleaded95: 2.05, diesel: 1.95, name:'Fallback' };
    let fuelPrices = { ...fallbackPrices };
    let userEditedPrice = false;

    function renderAvgPrices(){
      avgUnleaded91El.textContent = fmtMoney(fuelPrices.unleaded91);
      avgUnleaded95El.textContent = fmtMoney(fuelPrices.unleaded95);
      avgDieselEl.textContent = fmtMoney(fuelPrices.diesel);
    }
    renderAvgPrices();

    function getMode(){
      const el = document.querySelector('input[name="priceMode"]:checked');
      return el ? el.value : 'avg';
    }

    function getCountryName(cc){
      if(!cc) return '‚Äî';
      const e = countryPrices && countryPrices[cc];
      return (e && e.name) ? e.name : cc;
    }

    async function pricesForCountryStatic(cc){
      cc = (cc || "").toUpperCase();
      const e = countryPrices && countryPrices[cc];
      if(e) return { ...e };
      return { ...fallbackPrices };
    }

    function mixPrices(a, b){
      return {
        unleaded91: (a.unleaded91 + b.unleaded91) / 2,
        unleaded95: (a.unleaded95 + b.unleaded95) / 2,
        diesel:     (a.diesel + b.diesel) / 2,
        name: `${a.name} / ${b.name}`
      };
    }

    async function applyDetectedPrices(){
      const isCross = (startCC && destCC && startCC !== destCC);
      const mode = isCross ? getMode() : 'start';

      const startP = await pricesForCountryStatic(startCC);
      const destP  = await pricesForCountryStatic(destCC);

      let chosen, note;
      if(isCross){
        if(mode === 'start'){ chosen = startP; note = `Start (${startP.name})`; }
        else if(mode === 'dest'){ chosen = destP; note = `Destination (${destP.name})`; }
        else { chosen = mixPrices(startP, destP); note = `Average (${startP.name} ‚Üî ${destP.name})`; }
      }else{
        chosen = startP;
        note = startCC ? `Country: ${chosen.name}` : 'Country: ‚Äî';
      }

      fuelPrices = { unleaded91: chosen.unleaded91, unleaded95: chosen.unleaded95, diesel: chosen.diesel };
      renderAvgPrices();

      if(!userEditedPrice){
        priceEl.value = fuelPrices[fuelTypeEl.value] ?? '';
        const standTxt = priceStand ? ` (as of: ${priceStand})` : '';
        priceInfoEl.textContent =
          `${note}. Average fuel prices for orientation${standTxt}. You can adjust the price anytime.`;
        priceInfoEl.classList.remove('error');
      }
    }

    fuelTypeEl.addEventListener('change', () => {
      if(!userEditedPrice){
        priceEl.value = fuelPrices[fuelTypeEl.value] ?? '';
      }
    });

    priceEl.addEventListener('input', () => {
      userEditedPrice = true;
      priceInfoEl.textContent = '';
      priceInfoEl.classList.remove('error');
    });

    document.getElementById('btn-reset-price').addEventListener('click', async () => {
      userEditedPrice = false;
      await applyDetectedPrices();
    });

    document.querySelectorAll('input[name="priceMode"]').forEach(r => {
      r.addEventListener('change', async () => {
        if(!userEditedPrice && startCC && destCC) await applyDetectedPrices();
        await renderTollBreakdown();
      });
    });

    // ---------- Leaflet (always) ----------
    const map = L.map('map', { attributionControl:true }).setView([51.1657, 10.4515], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19,
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    function safeInvalidate(){ try { map.invalidateSize(); } catch(e){} }
    setTimeout(safeInvalidate, 80);
    setTimeout(safeInvalidate, 200);
    setTimeout(safeInvalidate, 650);
    window.addEventListener('resize', () => setTimeout(safeInvalidate, 180));
    window.addEventListener('orientationchange', () => setTimeout(safeInvalidate, 260));

    const mapEl = document.getElementById('map');
    if (window.ResizeObserver && mapEl) {
      const ro = new ResizeObserver(() => safeInvalidate());
      ro.observe(mapEl);
    }

    let markers = [];
    let routeLayer = null;

    function clearMarkers(){ markers.forEach(m=>map.removeLayer(m)); markers=[]; }
    function clearRoute(){ if(routeLayer){ map.removeLayer(routeLayer); routeLayer=null; } }
    function addMarker(lat, lon, label){
      const m = L.marker([lat, lon]).addTo(map).bindPopup(label || '');
      markers.push(m);
      return m;
    }

    // ---------- Geocoding / Reverse / Routing ----------
    async function geocode(q){
      const key = q.trim().toLowerCase();
      if(geoCache.has(key)) return geoCache.get(key);

      const url = API_BASE + '/api/geocode?q=' + encodeURIComponent(q);
      const res = await fetchWithTimeout(url, 12000);
      if(!res.ok) throw new Error('Geocoding failed');

      const data = await res.json();
      if(!Array.isArray(data) || !data.length) return null;

      const pick =
        data.find(x => x?.addresstype && x.addresstype !== "country") ||
        data.find(x => x?.type && x.type !== "country") ||
        data[0];

      const isCountry = (pick?.addresstype === "country" || pick?.type === "country");
      if(isCountry) return null;

      const out = { lat:+pick.lat, lon:+pick.lon, name:pick.display_name };
      geoCache.set(key, out);
      return out;
    }

    async function reverseCountryCode(lat, lon){
      const k = cacheKeyLL(lat,lon);
      if(revCache.has(k)) return revCache.get(k);

      const url = API_BASE + `/api/reverse?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const res = await fetchWithTimeout(url, 12000);
      if(!res.ok) return null;
      const j = await res.json();
      const cc = j?.address?.country_code ? String(j.address.country_code).toUpperCase() : null;
      revCache.set(k, cc);
      return cc;
    }

    async function getRouteOSRM(lat1, lon1, lat2, lon2){
      const a = {lat:lat1, lon:lon1}, b = {lat:lat2, lon:lon2};
      const ck = cacheKeyRoute(a,b);
      if(routeCache.has(ck)) return routeCache.get(ck);

      const url =
        API_BASE + `/api/route?lat1=${encodeURIComponent(lat1)}&lon1=${encodeURIComponent(lon1)}` +
        `&lat2=${encodeURIComponent(lat2)}&lon2=${encodeURIComponent(lon2)}`;

      const res = await fetchWithTimeout(url, 15000);
      if(!res.ok) throw new Error('Routing failed');

      const j = await res.json();
      if(!j || j.code !== 'Ok' || !j.routes || !j.routes.length) throw new Error('No route');

      const r = j.routes[0];
      const distKm = (r.distance || 0) / 1000;

      lastRouteGeo = r.geometry;
      lastKmByCountry = null;

      clearRoute();
      routeLayer = L.geoJSON(r.geometry, { style: { weight: 5, opacity: 0.9 } }).addTo(map);
      map.fitBounds(routeLayer.getBounds(), { padding:[60,60] });

      setTimeout(safeInvalidate, 60);
      setTimeout(safeInvalidate, 220);

      routeCache.set(ck, distKm);
      return distKm;
    }

    // ---------- Country split (few reverse samples = stable) ----------
    function haversineKm(lat1, lon1, lat2, lon2){
      const R = 6371;
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a =
        Math.sin(dLat/2)**2 +
        Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2 * R * Math.asin(Math.sqrt(a));
    }

    function downsampleLineString(coords, maxPoints=220){
      if(!coords || coords.length <= maxPoints) return coords;
      const step = Math.ceil(coords.length / maxPoints);
      const out = [];
      for(let i=0;i<coords.length;i+=step) out.push(coords[i]);
      if(out[out.length-1] !== coords[coords.length-1]) out.push(coords[coords.length-1]);
      return out;
    }

    async function splitRouteByCountry(routeGeo){
      if(!routeGeo || routeGeo.type !== "LineString" || !Array.isArray(routeGeo.coordinates)) return null;

      const coordsRaw = routeGeo.coordinates; // [ [lon,lat], ... ]
      const coords = downsampleLineString(coordsRaw, 220);
      if(coords.length < 2) return null;

      const MAX_SAMPLES = 12; // keep low

      const sampleIdx = [];
      for(let s=0; s<MAX_SAMPLES; s++){
        const t = (MAX_SAMPLES === 1) ? 0 : s/(MAX_SAMPLES-1);
        const idx = Math.round(t * (coords.length-1));
        if(sampleIdx[sampleIdx.length-1] !== idx) sampleIdx.push(idx);
      }

      const samples = sampleIdx.map(i => {
        const [lon,lat] = coords[i];
        return { lat, lon };
      });

      const sampleCC = [];
      for(const p of samples){
        const cc = await reverseCountryCode(p.lat, p.lon);
        sampleCC.push(cc || "‚Äî");
      }

      const kmByCC = {};
      for(let i=1;i<samples.length;i++){
        const a = samples[i-1], b = samples[i];
        const segKm = haversineKm(a.lat,a.lon,b.lat,b.lon);
        if(segKm <= 0) continue;

        const ccA = sampleCC[i-1], ccB = sampleCC[i];
        const cc = (ccB && ccB !== "‚Äî") ? ccB : (ccA || "‚Äî");
        kmByCC[cc] = (kmByCC[cc] || 0) + segKm;
      }

      return kmByCC;
    }

    // ---------- EU-only Toll/Vignette model ----------
    const EU_ONLY = new Set([
      "DE","AT","CH","FR","IT","ES","NL","BE","PL","CZ","SK","HU","SI","HR","RO","BG","GB"
    ]);

    // toll per 100 km (guideline)
    const tollPer100km = {
      DE:0, AT:0, CH:0, FR:10, IT:9, ES:10, NL:0, BE:0,
      PL:6, CZ:0, SK:0, HU:0, SI:0, HR:5, RO:0, BG:0, GB:0
    };

    // vignettes (flat, once per country)
    const vignetteFlat = {
      AT: 11.50, CH: 40.00, CZ: 12.00, SK: 12.00, HU: 16.00, SI: 16.00, RO: 3.50, BG: 7.50
    };

    function estimateTollForCountry(cc, km){
      const rate = (tollPer100km[cc] ?? 0);
      return Math.round(((km / 100) * rate) * 100) / 100;
    }
    function estimateVignetteForCountry(cc){
      const v = vignetteFlat[cc];
      return Number.isFinite(v) ? v : 0;
    }

    async function renderTollBreakdown(){
      const mySeq = ++tollRenderSeq;

      if(!routeKm || !lastRouteGeo){
        tollTotalEl.textContent = '‚Äî';
        vignetteTotalEl.textContent = '‚Äî';
        tollVignetteSumEl.textContent = '‚Äî';
        tollBreakdownEl.textContent = 'Enter start/destination and calculate the distance.';
        lastTollTotal = 0;
        lastVignetteTotal = 0;
        return;
      }

      if(!lastKmByCountry){
        tollBreakdownEl.innerHTML = '<span class="small">Calculating country shares‚Ä¶</span>';
        try{
          lastKmByCountry = await splitRouteByCountry(lastRouteGeo);
        }catch(e){
          lastKmByCountry = null;
        }
      }

      if(mySeq !== tollRenderSeq) return;

      if(!lastKmByCountry){
        tollTotalEl.textContent = '‚Äî';
        vignetteTotalEl.textContent = '‚Äî';
        tollVignetteSumEl.textContent = '‚Äî';
        tollBreakdownEl.innerHTML = '<span class="small">Toll/vignette split not available right now.</span>';
        lastTollTotal = 0;
        lastVignetteTotal = 0;
        return;
      }

      const parts = Object.entries(lastKmByCountry)
        .filter(([cc,km]) => cc && cc !== "‚Äî" && km > 0.4)
        .sort((a,b)=> b[1]-a[1])
        .map(([cc,km]) => ({cc, km}));

      if(!parts.length){
        tollTotalEl.textContent = '‚Äî';
        vignetteTotalEl.textContent = '‚Äî';
        tollVignetteSumEl.textContent = '‚Äî';
        tollBreakdownEl.innerHTML = '<span class="small">No countries detected.</span>';
        lastTollTotal = 0;
        lastVignetteTotal = 0;
        return;
      }

      // ‚úÖ EU-only gate: if any country not supported -> show not available + set totals to 0
      const allSupported = parts.every(p => EU_ONLY.has(p.cc));
      if(!allSupported){
        tollTotalEl.textContent = '‚Äî';
        vignetteTotalEl.textContent = '‚Äî';
        tollVignetteSumEl.textContent = '‚Äî';
        tollBreakdownEl.innerHTML =
          '<span class="small">Toll/vignette estimates are currently available for selected European countries only.</span>';
        lastTollTotal = 0;
        lastVignetteTotal = 0;
        return;
      }

      let tollSum = 0;
      let vignetteSum = 0;
      const seen = new Set();

      const lines = parts.map(p => {
        const name = getCountryName(p.cc);
        const toll = estimateTollForCountry(p.cc, p.km);
        tollSum += toll;

        if(!seen.has(p.cc)){
          vignetteSum += estimateVignetteForCountry(p.cc);
          seen.add(p.cc);
        }

        const rate = (tollPer100km[p.cc] ?? 0);
        return `‚Ä¢ ${name} (${p.cc}): ${fmtL(p.km)} km √ó ${fmt(rate)} ${CURRENCY_SYMBOL}/100 km ‚âà <b>${fmtMoney(toll)}</b>`;
      });

      lastTollTotal = tollSum;
      lastVignetteTotal = vignetteSum;

      tollTotalEl.textContent = fmtMoney(tollSum);
      vignetteTotalEl.textContent = fmtMoney(vignetteSum);
      tollVignetteSumEl.textContent = fmtMoney(tollSum + vignetteSum);

      tollBreakdownEl.innerHTML =
        lines.join('<br>') +
        (vignetteSum > 0 ? `<br><br><span class="small">Vignettes (flat, once per country): <b>${fmtMoney(vignetteSum)}</b></span>` : '') +
        `<br><span class="small">Note: values are guidelines and may vary by route and vehicle class.</span>`;
    }

    // ---------- Route buttons ----------
    const btnGeocode = document.getElementById('btn-geocode');

    btnGeocode.addEventListener('click', async () => {
      const now = Date.now();
      if(isRouting) return;
      if(now - lastRouteClick < 900) return;
      lastRouteClick = now;

      const from = placeFromEl.value.trim();
      const to = placeToEl.value.trim();

      if(!from || !to){
        tollInfoEl.textContent = 'Please enter start and destination.';
        tollInfoEl.classList.add('error');
        return;
      }

      try{
        isRouting = true;
        btnGeocode.disabled = true;

        tollInfoEl.textContent = 'Calculating route‚Ä¶';
        tollInfoEl.classList.remove('error');

        const a = await geocode(from);
        const b = await geocode(to);
        if(!a || !b){
          tollInfoEl.textContent = 'Please enter a city/place + country (e.g. "Munich, Germany").';
          tollInfoEl.classList.add('error');
          return;
        }

        startCC = await reverseCountryCode(a.lat, a.lon);
        destCC  = await reverseCountryCode(b.lat, b.lon);

        const startName = getCountryName(startCC);
        const destName  = getCountryName(destCC);

        badgeEl.innerHTML =
          `Detected: <b>Start</b> ${startName} (${startCC||'‚Äî'}), <b>Destination</b> ${destName} (${destCC||'‚Äî'})` +
          (!countryPrices ? `<br><span class="error">‚ö† Price file missing in /prices/</span>` : '');

        if(startCC && destCC && startCC !== destCC) priceModeWrap.style.display = 'block';
        else priceModeWrap.style.display = 'none';

        clearMarkers();
        addMarker(a.lat,a.lon,'Start: ' + a.name);
        addMarker(b.lat,b.lon,'Destination: ' + b.name);

        routeKm = await getRouteOSRM(a.lat, a.lon, b.lat, b.lon);
        kmEl.value = Math.round(routeKm*10)/10;

        await applyDetectedPrices();
        await renderTollBreakdown();

        tollInfoEl.textContent = `Distance: ${fmtL(routeKm)} km.`;
        setTimeout(safeInvalidate, 120);

      }catch(e){
        tollInfoEl.textContent = 'Error routing/geocoding. Please try again.';
        tollInfoEl.classList.add('error');
      }finally{
        isRouting = false;
        btnGeocode.disabled = false;
      }
    });

    document.getElementById('btn-clearmap').addEventListener('click', async () => {
      clearMarkers(); clearRoute();
      map.setView([51.1657, 10.4515], 5);

      placeFromEl.value = '';
      placeToEl.value = '';
      badgeEl.textContent = '';
      priceModeWrap.style.display = 'none';

      startCC = null; destCC = null;
      routeKm = 0;

      lastRouteGeo = null;
      lastKmByCountry = null;

      tollInfoEl.textContent = '';
      tollInfoEl.classList.remove('error');

      lastTollTotal = 0;
      lastVignetteTotal = 0;
      await renderTollBreakdown();

      setTimeout(safeInvalidate, 120);
    });

    // km spinner
    document.getElementById('km-inc').addEventListener('click', ()=>{ const cur = parse(kmEl.value)||0; kmEl.value = Math.round((cur+1)*10)/10; });
    document.getElementById('km-dec').addEventListener('click', ()=>{ const cur = parse(kmEl.value)||0; kmEl.value = Math.max(0, Math.round((cur-1)*10)/10); });

    // ---------- Costs ----------
    function estimateRunningPer100(consumptionL100){
      if(!Number.isFinite(consumptionL100) || consumptionL100 <= 0) return 12.0;
      const est = 1.2 * consumptionL100 + 3.5;
      return Math.max(5, Math.min(30, Math.round(est * 10) / 10));
    }

    document.getElementById('calc-fuel').addEventListener('click', () => {
      const km = parse(kmEl.value);
      const v  = parse(consumptionEl.value);
      let p    = parse(priceEl.value);
      const passengers = Math.max(1, Math.floor(parse(passengersEl.value) || 1));

      if(!Number.isFinite(p)){
        p = (fuelPrices[fuelTypeEl.value] ?? NaN);
      }
      if(Number.isNaN(km) || km <= 0 || Number.isNaN(v) || Number.isNaN(p)){
        priceInfoEl.textContent = 'Please enter distance, consumption and price correctly.';
        priceInfoEl.classList.add('error');
        return;
      }
      priceInfoEl.textContent = '';
      priceInfoEl.classList.remove('error');

      const liters = (km * v) / 100;
      const costFuel = liters * p;

      const runningPer100Base = estimateRunningPer100(v);

      // ‚úÖ toll/vignette only if available (EU-only gate sets totals to 0)
      const tollPer100 = (km > 0) ? ((lastTollTotal + lastVignetteTotal) / km * 100) : 0;
      const runningPer100Total = runningPer100Base + (tollPer100 || 0);

      const costRunning = (km * runningPer100Total) / 100;
      const total = costFuel + costRunning;
      const perPerson = total / passengers;
      const avgPer100 = (total / km) * 100;

      litersEl.textContent = fmt(liters) + ' L';
      costFuelEl.textContent = fmtMoney(costFuel);
      costRunningEl.textContent = fmtMoney(costRunning);
      costTotalEl.textContent = fmtMoney(total);
      costPersonEl.textContent = fmtMoney(perPerson);
      avg100El.textContent = fmtMoney(avgPer100) + ' /100km';
      runningEstEl.textContent = fmtMoney(runningPer100Total) + ' /100km';

      const isDiesel = (fuelTypeEl.value === 'diesel');
      const co2FactorKgPerL = isDiesel ? 2.65 : 2.33;
      const co2Kg = liters * co2FactorKgPerL;
      const co2PerPersonKg = co2Kg / passengers;

      co2TotalEl.textContent = fmt(co2Kg) + ' kg';
      co2PerPersonEl.textContent = fmt(co2PerPersonKg) + ' kg';

      const gPerKmCar = 164;
      const gPerPkmRail = 26;
      const gPerPkmFlight = 290;

      const cmpCarKg = (km * gPerKmCar) / 1000;
      const cmpRailKg = (km * passengers * gPerPkmRail) / 1000;
      const cmpFlightKg = (km * passengers * gPerPkmFlight) / 1000;

      cmpCarEl.textContent = fmt(cmpCarKg) + ' kg';
      cmpRailEl.textContent = fmt(cmpRailKg) + ' kg';
      cmpFlightEl.textContent = fmt(cmpFlightKg) + ' kg';
    });

    document.getElementById('reset-fuel').addEventListener('click', async () => {
      kmEl.value = '';
      consumptionEl.value = '7.5';
      priceEl.value = '';
      passengersEl.value = 1;

      litersEl.textContent='0.00 L';
      costFuelEl.textContent='$0.00';
      costRunningEl.textContent='$0.00';
      costTotalEl.textContent='$0.00';
      costPersonEl.textContent='$0.00';
      avg100El.textContent='$0.00 /100km';
      runningEstEl.textContent='‚Äî';

      co2TotalEl.textContent='‚Äî';
      co2PerPersonEl.textContent='‚Äî';
      cmpCarEl.textContent='‚Äî';
      cmpRailEl.textContent='‚Äî';
      cmpFlightEl.textContent='‚Äî';

      userEditedPrice = false;
      fuelPrices = { ...fallbackPrices };
      renderAvgPrices();

      lastTollTotal = 0;
      lastVignetteTotal = 0;

      lastRouteGeo = null;
      lastKmByCountry = null;
      routeKm = 0;

      await renderTollBreakdown();

      clearMarkers();
      clearRoute();
      map.setView([51.1657, 10.4515],5);
      setTimeout(safeInvalidate, 120);
    });

    // initial
    renderTollBreakdown();
  });
  </script>

  <script>
    async function loadPart(id, url){
      const el = document.getElementById(id);
      if(!el) return false;
      try{
        const r = await fetch(url, { cache: 'no-cache' });
        el.innerHTML = await r.text();
        return true;
      }catch(e){
        console.warn('Could not load:', url);
        return false;
      }
    }

    function initMobileNav(){
      const header = document.querySelector('.site-header');
      const btn = document.querySelector('.nav-toggle');
      const nav = document.getElementById('site-nav');
      if(!header || !btn || !nav) return;

      const close = () => {
        header.classList.remove('is-open');
        btn.setAttribute('aria-expanded', 'false');
        btn.setAttribute('aria-label', 'Open menu');
      };

      const open = () => {
        header.classList.add('is-open');
        btn.setAttribute('aria-expanded', 'true');
        btn.setAttribute('aria-label', 'Close menu');
      };

      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        header.classList.contains('is-open') ? close() : open();
      });

      document.addEventListener('click', (e) => {
        if(!header.classList.contains('is-open')) return;
        if(header.contains(e.target)) return;
        close();
      });

      document.addEventListener('keydown', (e) => {
        if(e.key === 'Escape') close();
      });

      window.addEventListener('resize', () => {
        if(window.innerWidth > 720) close();
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await loadPart('site-header', '/practice/header.html');
      initMobileNav();
      await loadPart('site-footer', '/practice/footer.html');
    });
  </script>

</body>
</html>
